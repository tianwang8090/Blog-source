<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 优先使用 IE 最新版本和 Chrome -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <!-- 是否启用 WebApp 全屏模式，删除苹果默认的工具栏和菜单栏 -->
    <meta name="apple-itunes-app" content="app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="yes" name="apple-touch-fullscreen">
    <meta content="telephone=no" name="format-detection">
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <title>snake</title>
    <style>
        html,
        body {
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #wrap {
            position: relative;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        #box {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            margin: auto;
            border: .5px solid #E91E63;
        }

        .sb {
            border-radius: 50%;
            -webkit-transition: all .2s ease;
            -moz-transition: all .2s ease;
            transition: all .2s ease;
        }

        .food {
            -webkit-transition: all .5s ease;
            -moz-transition: all .5s ease;
            transition: all .5s ease;
        }

        #top {
            position: relative;
            top: 15px;
            width: 24rem;
            margin: 0 auto;
            height: 40px;
            overflow: hidden;
        }

        #btn {
            position: absolute;
            background: #f93c3c;
            bottom: 15px;
            left: 0px;
            right: 0px;
            margin: 0 auto;
            width: 24rem;
            height: 40px;
            box-sizing: border-box;
            color: #fff;
            font-weight: lighter;
            font-size: large;
            line-height: 40px;
            border-radius: 20px;
            cursor: pointer;
            text-align: center;
        }

        #time {
            float: right;
            width: 110px;
            height: 40px;
            border-radius: 20px;
            background-color: #fff;
            color: #f93c3c;
            font-weight: bolder;
            font-size: large;
            text-align: center;
            line-height: 40px;
        }

        #score {
            float: left;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background-color: #fff;
            color: #f93c3c;
            font-weight: bolder;
            font-size: large;
            text-align: center;
            line-height: 40px;
        }

        #level {
            float: left;
            margin-left: 10px;
            width: 100px;
            height: 40px;
            border-radius: 20px;
            background-color: #fff;
            color: #f93c3c;
            font-weight: bolder;
            font-size: large;
            text-align: center;
            line-height: 40px;
        }

        canvas {
            position: absolute;
            top: 0;
            z-index: -1;
        }
    </style>
</head>

<body>
    <div id="wrap">
        <div id="box"></div>
        <div id="top">
            <div id="score">00</div>
            <div id="level">Level 1</div>
            <div id="time">00:00:00</div>
        </div>
        <div id="btn">开始</div>
    </div>
    <canvas></canvas>
    <script>
        var GAME = null;

        window.onload = function () {
            var w = document.documentElement.clientWidth;
            if (w <= 414) {
                document.documentElement.style.fontSize = document.documentElement.clientWidth / (375 / 13.33) +
                    "px";
            } else if (w > 414 && w <= 768) {
                document.documentElement.style.fontSize = document.documentElement.clientWidth / (375 / 12.33) +
                    "px";
            }

            GAME = new Game();
            GAME.init();

            Mobile();

            $("btn").onclick = function (e) {
                GAME.control();
                e.preventDefault();
            };

            document.onkeydown = function (e) {
                var code = e.keyCode || e.which;
                if (code >= 37 && code <= 40) {
                    GAME.s.direction(code);
                } else if (code === 13 || code === 32) {
                    GAME.control();
                }
            }
        }
        window.onunload = function () {
            clearTimeout(GAME.s.T);
            clearInterval(GAME.T);
            GAME = null;
        }

        function Mobile() {
            var s = e = [0, 0];

            $("box").ontouchstart = function (ev) {
                ev.preventDefault();
                var t = ev.targetTouches[0];
                s = [t.pageX, t.pageY];
            }
            $("box").ontouchmove = function (ev) {
                ev.preventDefault();
            }
            $("box").ontouchend = function (ev) {
                ev.preventDefault();
                var t = ev.changedTouches[0];
                e = [t.pageX, t.pageY];
                GAME.status === "start" ? cal() : null;
            }
            /* document.body.addEventListener("touchmove", function (e) {
                e.preventDefault();
            }, false); */
            function cal() {
                var x = e[0] - s[0],
                    y = e[1] - s[1],
                    t = y / x,
                    c = -1;
                if (x === 0) {
                    c = t1 < 0 ? 38 : 40
                } else if (x > 0) {
                    if (t > -1 && t < 1) {
                        c = 39;
                    } else if (t <= -1) {
                        c = 38;
                    } else {
                        c = 40;
                    }
                } else {
                    if (t > -1 && t < 1) {
                        c = 37;
                    } else if (t <= -1) {
                        c = 40;
                    } else {
                        c = 38;
                    }
                }
                c > 0 ? GAME.s.direction(c) : null;
            }
        }

        function Game() {
            this.status = "ready";
            this.allStatus = {
                ready: "开始",
                start: "暂停",
                pause: "继续",
                end: "再来一局"
            };
            this.score = null;
            this.t = null;
            this.b = null;
            this.f = null;
            this.s = null;
            this.l = null;
            this.tr = null;
            this.T = -1;
            this.control = function () {
                switch (this.status) {
                    case "ready":
                        this.start();
                        break;
                    case "start":
                        this.pause();
                        break;
                    case "pause":
                        this.start();
                        break;
                    case "end":
                        this.init();
                        break;

                    default:
                        break;
                }
            }
            this.ready = function () {
                this.score = new Score("score");
                this.b = new Box("box");
                this.f = new Food();
                this.s = new Snake();
                this.t = new Time("time");
                this.l = new Level("level");
                this.tr = new Tran();
                this.b.show();
                this.f.show();
                this.s.show();
                this.l.show();
                this.tr.init();
                this.setStatus("ready");
            };
            this.start = function () {
                if (this.T > 0) {
                    clearInterval(this.T);
                }
                this.T = setInterval(function () {
                    this.t.refresh();
                }.bind(this), 10);
                this.s.go();
                this.setStatus("start");
            };
            this.pause = function () {
                if (this.T > 0) {
                    clearInterval(this.T);
                }
                this.s.stop();
                this.setStatus("pause");
            };
            this.end = function () {
                clearInterval(this.T);
                this.setStatus("end");
                alert("承让承让、用时" + this.t.v + "才区区" + this.score.v + "分");
            }
            this.setStatus = function (s) {
                s && (this.status = s);
                $("btn").innerText = this.allStatus[this.status];
            }
            this.init = function () {
                var items = $("box").children;
                for (var i = items.length - 1; i >= 0; i--) {
                    items[i].parentNode.removeChild(items[i]);
                }
                this.score && this.score.reset();
                this.t && this.t.reset();
                this.l && this.l.reset();
                this.ready();
            }
            this.foodDie = function () {
                this.f.die();
                this.f = null;
                this.f = new Food();
                this.f.show();
                this.score.set(this.s.s.length);
                if (this.s.s.length % 4 === 0) {
                    this.l.set(this.s.s.length / 4 + 1);
                    this.speed();
                }
            }
            this.speed = function () {
                this.s.t -= .05;
            }
        }

        function Score(id) {
            this.v = 0;
            this.show = function () {
                $(id).innerText = this.v;
            };
            this.set = function (v) {
                this.v = v;
                this.show();
            }
            this.reset = function () {
                this.v = 0;
                this.show();
            }
        }

        function Level(id) {
            this.v = 1;
            this.show = function () {
                $(id).innerText = "Level " + this.v;
            };
            this.set = function (v) {
                this.v = v;
                this.show();
            }
            this.reset = function () {
                this.v = 1;
                this.show();
            }
        }

        function Time(id) {
            this.v = "00:00:00";
            this.m = 0;
            this.s = 0;
            this.ss = 0;
            this.refresh = function () {
                this.ss++;
                if (this.ss >= 100) {
                    this.ss = 0;
                    this.s++;
                }
                if (this.s >= 60) {
                    this.m++;
                    this.s = 0;
                }
                this.v = this.add0(this.m) + ":" + this.add0(this.s) + ":" + this.add0(this.ss);
                this.show();
            }
            this.add0 = function (t) {
                return t < 10 ? "0" + t : t;
            }
            this.show = function () {
                $(id).innerText = this.v;
            }
            this.reset = function () {
                this.v = "00:00:00";
                this.show();
            }
        }

        function Box(id) {
            this.w = 24;
            this.h = 34;
            this.show = function () {
                this.ins.style.width = this.w + "rem";
                this.ins.style.height = this.h + "rem";
            }
            this.ins = $(id);
        }

        function Food() {
            this.f = [Math.floor(GAME.b.w * Math.random()), Math.floor(GAME.b.h * Math.random()), this.color()];
            this.w = 1;
            this.h = 1;
            this.x = this.f[0];
            this.y = this.f[1];
            this.ins = null;
        }
        Food.prototype = {
            show: function () {
                var i = document.createElement("div");
                i.className = "food";
                i.style.position = "absolute";
                i.style.width = this.w + "rem";
                i.style.height = this.h + "rem";
                i.style.left = this.x + "rem";
                i.style.top = this.y + "rem";
                i.style.background = this.f[2];
                i.style.borderRadius = "50%";
                this.ins = i;
                GAME.b.ins.appendChild(this.ins);
            },
            die: function () {
                this.ins.parentNode.removeChild(this.ins);
                this.ins = null;
            },
            color: function () {
                var r = "0123456789abcdef",
                    s = "#";
                while (s.length < 7) {
                    s += r.charAt(Math.floor(Math.random() * 16));
                }
                return s;
            }
        }

        function Snake() {
            this.s = [
                [3, 3, "#f93c3c", null],
                [2, 3, "#e8d535", null],
                [1, 3, "#e8d535", null]
            ];
            this.w = 1;
            this.h = 1;
            this.t = .45;
            this.T = -1;
            this.d = "right";
        }
        Snake.prototype = {
            show: function () {
                /* this.s.forEach(function (e, i) {
                    e[3] && e[3].parentNode.removeChild(e[3]);
                }); */
                this.s.forEach(function (e, i) {
                    var o = e[3] || document.createElement("div");
                    o.className = "sb";
                    o.style.position = "absolute";
                    o.style.width = this.w + "rem";
                    o.style.height = this.h + "rem";
                    o.style.left = e[0] * this.w + "rem";
                    o.style.top = e[1] * this.h + "rem";
                    o.style.background = e[2];
                    e[3] || GAME.b.ins.appendChild(o);
                    e[3] = o;
                }, this);
            },
            direction: function (code) {
                if (!code) return;
                if (GAME.status !== "start") return;
                var d = this.d;
                switch (code) {
                    case 38:
                        d = "up";
                        break;
                    case 39:
                        d = "right";
                        break;
                    case 40:
                        d = "down";
                        break;
                    case 37:
                        d = "left";
                        break;
                    default:
                        break;
                }
                switch (this.d) {
                    case "up":
                        if (d === "down") return;
                        break;
                    case "right":
                        if (d === "left") return;
                        break;
                    case "down":
                        if (d === "up") return;
                        break;
                    case "left":
                        if (d === "right") return;
                        break;
                    default:
                        break;
                }
                this.d = d;
            },
            move: function () {
                var d1 = d2 = false;
                for (var i = this.s.length - 1; i > 0; i--) {
                    this.s[i][0] = this.s[i - 1][0];
                    this.s[i][1] = this.s[i - 1][1];
                }
                switch (this.d) {
                    case "up":
                        this.s[0][1]--;
                        break;
                    case "right":
                        this.s[0][0]++;
                        break;
                    case "down":
                        this.s[0][1]++;
                        break;
                    case "left":
                        this.s[0][0]--;
                        break;
                    default:
                        break;
                }
                d1 = this.s[0][0] * this.w <
                    0 || this.s[0][0] * this.w >= GAME.b.w || this.s[0][1] * this.h <
                    0 || this.s[0][1] * this.h >= GAME.b.h;
                if (d1) {
                    this.die();
                    return;
                }
                this.s.forEach(function (e, i, a) {
                    if (i !== 0 && e[0] === a[0][0] && e[1] === a[0][1]) {
                        d2 = true;
                        return false;
                    }
                });
                if (d2) {
                    this.die();
                    return;
                }
                this.show();
                this.eat();
            },
            die: function () {
                this.stop();
                GAME.end();
            },
            eat: function () {
                var h = this.s[0],
                    f = GAME.f;
                if (h[0] === f.f[0] && h[1] === f.f[1]) {
                    GAME.foodDie();
                    var i = this.s[this.s.length - 1];
                    this.s.push([i[0], i[1], f.f[2], null]);
                }
            },
            go: function () {
                if (this.T > 0) {
                    clearTimeout(this.T);
                }
                this.T = setTimeout(this.go.bind(this), this.t * 1000);
                this.move();
            },
            stop: function () {
                clearTimeout(this.T);
            }
        }

        function Tran() {
            var c = document.getElementsByTagName("canvas")[0],
                x = c.getContext('2d'),
                pr = 1 || window.devicePixelRatio || 1,
                w = window.innerWidth,
                h = window.innerHeight,
                f = 90,
                q,
                m = Math,
                r = 0,
                u = m.PI * 2,
                v = m.cos,
                z = m.random;
            document.body.appendChild(c);
            c.width = w * pr;
            c.height = h * pr;
            x.scale(pr, pr);
            x.globalAlpha = 0.6;

            this.init = i;

            function i() {
                x.clearRect(0, 0, w, h)
                q = [{
                    x: 0,
                    y: h * .7 + f
                }, {
                    x: 0,
                    y: h * .7 - f
                }]
                while (q[1].x < w + f) d(q[0], q[1])
            }

            function d(i, j) {
                x.beginPath()
                x.moveTo(i.x, i.y)
                x.lineTo(j.x, j.y)
                var k = j.x + (z() * 2 - 0.25) * f,
                    n = y(j.y)
                x.lineTo(k, n)
                x.closePath()
                r -= u / -50
                x.fillStyle = '#' + (v(r) * 127 + 128 << 16 | v(r + u / 3) * 127 + 128 << 8 | v(r + u / 3 * 2) * 127 +
                    128).toString(16)
                x.fill()
                q[0] = q[1]
                q[1] = {
                    x: k,
                    y: n
                }
            }

            function y(p) {
                var t = p + (z() * 2 - 1.1) * f
                return (t > h || t < 0) ? y(p) : t
            }
        }

        function $(id) {
            return document.getElementById(id);
        }
    </script>
</body>

</html>
